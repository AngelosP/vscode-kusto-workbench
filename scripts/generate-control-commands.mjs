import fs from 'node:fs/promises';
import path from 'node:path';

const TOC_URL = 'https://learn.microsoft.com/en-us/kusto/toc.json?view=azure-data-explorer';
const OUT_FILE = path.resolve('media/queryEditor/controlCommands.generated.js');

const isObject = (v) => v && typeof v === 'object' && !Array.isArray(v);

const collectDotEntries = (node, out) => {
	if (!node) return;
	if (Array.isArray(node)) {
		for (const n of node) collectDotEntries(n, out);
		return;
	}
	if (!isObject(node)) return;

	// Learn TOC node shapes vary; try the common fields.
	const title = String(node.toc_title ?? node.displayName ?? node.name ?? '').trim();
	const href = String(node.href ?? '').trim();
	if (title.startsWith('.') && href) {
		out.push([title, href]);
	}
	if (Array.isArray(node.items)) collectDotEntries(node.items, out);
	if (Array.isArray(node.children)) collectDotEntries(node.children, out);
};

const main = async () => {
	const res = await fetch(TOC_URL, { headers: { 'accept': 'application/json' } });
	if (!res.ok) {
		throw new Error(`Failed to fetch TOC: ${res.status} ${res.statusText}`);
	}
	const root = await res.json();
	const items = Array.isArray(root?.items) ? root.items : [];

	const entries = [];
	collectDotEntries(items, entries);

	// Dedupe while preserving order.
	const seen = new Set();
	const deduped = [];
	for (const [t, h] of entries) {
		const key = `${String(t).toLowerCase()}|${String(h)}`;
		if (seen.has(key)) continue;
		seen.add(key);
		deduped.push([t, h]);
	}

	const banner = [
		'// AUTO-GENERATED FILE. DO NOT EDIT BY HAND.',
		'// Generated by: node scripts/generate-control-commands.mjs',
		''
	].join('\n');

	// Expose as a global so the webview can use it without bundling.
	const payload = `${banner}(function(){\n\twindow.__kustoControlCommandEntries = ${JSON.stringify(deduped)};\n})();\n`;
	await fs.mkdir(path.dirname(OUT_FILE), { recursive: true });
	await fs.writeFile(OUT_FILE, payload, 'utf8');

	console.log(`Wrote ${deduped.length} entries to ${path.relative(process.cwd(), OUT_FILE)}`);
};

main().catch((err) => {
	console.error(err);
	process.exitCode = 1;
});
